<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Image Viewer</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html,
    body {
      height: 100%;
      background-color: black;
      color: white;
      font-family: sans-serif;
      overflow: hidden;
    }

    .container {
      display: flex;
      height: 100vh;
      width: 100vw;
    }

    .panel {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
      background-color: black;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .panel img {
      max-width: 100%;
      height: auto;
      margin-bottom: 10px;
      display: none;
    }

    .panel img.active {
      display: block;
    }

    .message {
      color: gray;
      margin-top: 20px;
    }
  </style>
</head>

<body>
  <div class="container">
    <div id="left-panel" class="panel"></div>
    <div id="right-panel" class="panel"></div>
  </div>

  <script>
const config = {
  left: { rotateIntervalSec: 5, refreshIntervalSec: 60 },
  right: { rotateIntervalSec: 15, refreshIntervalSec: 60 }
};

const state = {
  left: {
    images: [],
    currentIndex: 0,
    rotateTimer: null,
    refreshTimer: null,
    currentRotateInterval: null,
    currentRefreshInterval: null,
  },
  right: {
    images: [],
    currentIndex: 0,
    rotateTimer: null,
    refreshTimer: null,
    currentRotateInterval: null,
    currentRefreshInterval: null,
  }
};

// Rotate to next image
function rotateImage(folder) {
  const images = state[folder].images;
  if (images.length === 0) return;
  state[folder].currentIndex = (state[folder].currentIndex + 1) % images.length;
  showImage(folder);
}

// Show current image
function showImage(folder) {
  const container = document.getElementById(folder === "left" ? "left-panel" : "right-panel");
  container.innerHTML = "";
  const images = state[folder].images;

  if (images.length === 0) {
    container.innerHTML = `<div class="message"></div>`;
    return;
  }

  images.forEach((file, idx) => {
    const img = document.createElement("img");
    img.src = `/uploads/${folder}/${file}`;
    if (idx === state[folder].currentIndex) img.classList.add("active");
    container.appendChild(img);
  });
}

// Load images from server
async function fetchImages(folder) {
  try {
    const response = await fetch(`/api/files?folder=${folder}`);
    if (!response.ok) throw new Error(`HTTP ${response.status}`);
    const data = await response.json();
    return data.files || [];
  } catch (err) {
    console.warn(`Could not load folder "${folder}":`, err);
    return [];
  }
}

// Refresh images if changed
async function refreshImages(folder) {
  const newImages = await fetchImages(folder);
  if (JSON.stringify(newImages) !== JSON.stringify(state[folder].images)) {
    state[folder].images = newImages;
    state[folder].currentIndex = 0;
    showImage(folder);
  }
}

// NEW: Set or update timers only if interval changed
function updateTimers(folder) {
  const cfg = config[folder];
  const st = state[folder];

  // Rotate timer
  if (cfg.rotateIntervalSec !== st.currentRotateInterval) {
    clearInterval(st.rotateTimer);
    st.rotateTimer = setInterval(() => rotateImage(folder), cfg.rotateIntervalSec * 1000);
    st.currentRotateInterval = cfg.rotateIntervalSec;
    console.log(`[${folder}] Rotate timer set to ${cfg.rotateIntervalSec}s`);
  }

  // Refresh timer
  if (cfg.refreshIntervalSec !== st.currentRefreshInterval) {
    clearInterval(st.refreshTimer);
    st.refreshTimer = setInterval(() => refreshImages(folder), cfg.refreshIntervalSec * 1000);
    st.currentRefreshInterval = cfg.refreshIntervalSec;
    console.log(`[${folder}] Refresh timer set to ${cfg.refreshIntervalSec}s`);
  }
}

// Fetch and apply server config for one side
async function fetchSideConfig(side) {
  try {
    const res = await fetch(`/config?side=${encodeURIComponent(side)}`);
    if (!res.ok) throw new Error('Fetch failed');
    const serverConfig = await res.json();

    config[side].rotateIntervalSec = serverConfig.secondsBetweenImages ?? config[side].rotateIntervalSec;
    // config[side].refreshIntervalSec = serverConfig.secondsBetweenRefresh ?? config[side].refreshIntervalSec;

    updateTimers(side);
  } catch (err) {
    console.warn(`Could not fetch config for ${side}, using defaults.`, err);
  }
}

// Initial setup
async function startPanel(folder) {
  state[folder].images = await fetchImages(folder);
  showImage(folder);
  updateTimers(folder);
}

// Load everything
async function loadConfigs() {
  await Promise.all([
    fetchSideConfig('left'),
    fetchSideConfig('right')
  ]);

  await startPanel("left");
  await startPanel("right");

  // Refresh config every 60s
  setInterval(() => {
    fetchSideConfig('left');
    fetchSideConfig('right');
  }, 60 * 1000);
}

loadConfigs();

  </script>
</body>

</html>